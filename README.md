# userService

Java 23 / Spring Boot 3.5.7 service that combines a traditional username/password login API with Spring Authorization Server (OAuth2/OIDC) backed by MySQL.

## Prerequisites

- Java 23
- Maven 3.9+
- MySQL running locally with database `userServiceDB` and user `badari` / `badari@123`

```sql
CREATE DATABASE userServiceDB;
CREATE USER 'badari'@'%' IDENTIFIED BY 'badari@123';
GRANT ALL PRIVILEGES ON userServiceDB.* TO 'badari'@'%';
FLUSH PRIVILEGES;
```

## Build & Run

```bash
mvn clean package
mvn spring-boot:run
```

The app listens on `http://localhost:9000`.

## API Highlight

### 1. Signup

```
POST /auth/sign_up
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "P@ssw0rd"
}
```

### 2. Login

```
POST /auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "P@ssw0rd"
}
```

Returns a JWT in the `AUTH_TOKEN` header generated with `JwtService`. Use this token for `/auth/validate`.

### 3. Validate Token

```
POST /auth/validate
Content-Type: application/json

{
  "token": "<token from login>"
}
```

`/auth/validate` only works with the token generated by the login endpoint, not with the OAuth Authorization Server token.

## OAuth Authorization Server

- Authorization endpoint: `http://localhost:9000/oauth2/authorize`
- Token endpoint: `http://localhost:9000/oauth2/token`
- Default client: `oidc-client` / `secret`
- Redirect URIs configured for Postman and local callback.

The initializer registers the client on startup. If you change the client secret or redirect URIs, delete the row in the `client` table and restart.

## Troubleshooting

- `400 Bad Request` with `@class` hints: ensure you’re sending valid JSON; no `@class` metadata is needed anymore.
- `invalid_client` from `/oauth2/token`: confirm the client secret stored in DB is the BCrypt hash produced by `passwordEncoder.encode("secret")` and Postman sends `secret`.
- `LinkedHashMap cannot be cast ... OAuth2TokenFormat`: delete old rows in `client` table so the initializer recreates them with the new token settings schema.

## Project Layout

- `controler` – REST controllers (`AuthControler`)
- `service` – Core services (`AuthService`, `JwtService`)
- `service/oauth2` – JPA-backed Spring Authorization Server adapters
- `models` – JPA entities (`User`, `Role`, `Session`, OAuth2 entities)
- `repository` – Spring Data repositories
- `configs` – Security config, beans, initializer


